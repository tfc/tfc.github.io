<!doctype html>
<html lang="en-us"><head><link href="http://gmpg.org/xfn/11" rel="profile">
<link type="application/atom+xml" rel="alternate" href="https://blog.galowicz.de/feed.xml" title="Jacek's Software Engineering Blog" />
<link rel="stylesheet" href="../../../../css/poole.css">
<link rel="stylesheet" href="../../../../css/syntax.css">
<link rel="stylesheet" href="../../../../css/hyde.css">
<script src="https://kit.fontawesome.com/796c2aa0a7.js" crossorigin="anonymous"></script></script>
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="../../../../images/apple-touch-icon-144-precomposed.png">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css" integrity="sha384-vKruj+a13U8yHIkAyGgK1J3ArTLzrFGBbBc0tDp4ad/EyewESeXE/Iv67Aj8gKZ0" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.js" integrity="sha384-PwRUT/YqbnEjkZO0zZxNqcxACrXe+j766U2amXcgMg5457rve2Y7I6ZJSm2A0mS4" crossorigin="anonymous"></script></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/contrib/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script></script>
<link rel="shortcut icon" href="../../../../images/favicon.ico">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<title>Jacek's Blog &middot; Useful type traits with if_compiles semantics</title>
</head>
<body class="layout-reverse"><div class="sidebar"><div class="container sidebar-sticky"><div class="sidebar-about"><h1><a href="../../../../">Jacek's Blog</a>
</h1>
<p class="lead">Software Engineering Consultant</p>
</div>
<nav class="sidebar-nav"><a class="sidebar-nav-item active" href="../../../../">Home</a>
<a class="sidebar-nav-item" href="../../../../about.html">About / CV</a>
<a class="sidebar-nav-item" href="../../../../impressum.html">Impressum</a>
<a class="sidebar-nav-item" href="../../../../datenschutz.html">Datenschutz / Cookies</a>
</nav>
<p><a href="https://linkedin.com/in/jgalowicz"><i class="fa-brands fa-linkedin"></i>
</a>
<a href="https://www.xing.com/profile/Jacek_Galowicz"><i class="fa-brands fa-square-xing"></i>
</a>
<a href="https://github.com/tfc"><i class="fa-brands fa-square-github"></i>
</a>
<a href="https://twitter.com/jgalowicz"><i class="fa-brands fa-square-twitter"></i>
</a>
<a rel="me" href="https://functional.cafe/@jgalowicz"><i class="fa-brands fa-mastodon"></i>
</a>
</p>
</div>
</div>
<div class="content container"><h1>Useful type traits with if_compiles semantics</h1>
<div class="post"><span class="post-date">February 21, 2016</span>
<span class="post-tags">
Tags: <a title="All pages tagged 'c++'." href="../../../../tags/c%2B%2B.html" class="tag-link">c++</a> <a title="All pages tagged 'metaprogramming'." href="../../../../tags/metaprogramming.html" class="tag-link">metaprogramming</a>
</span>
<!-- cSpell:disable -->
<p>SFINAE type traits are very mighty, because they can check a lot of properties of types in a non-intrusive way.
Unfortunately, they are extremely bloaty to implement.
The single interesting expression within an SFINAE type trait is surrounded by lots of boiler plate code, which is ugly to read and repetitive.
This article shows a nice one-liner approach to define new SFINAE type traits.</p>
<!--more-->
<blockquote>
<p>If you are not familiar with <em>SFINAE</em>, have a look at the article which <a href="../../../../2016/02/19/how_do_sfinae_traits_work">describes how SFINAE works</a>.</p>
</blockquote>
<h2 id="encapsulating-the-boiler-plate-into-a-macro">Encapsulating the Boiler Plate into a Macro</h2>
<p>I learned about this useful little trick, when i attended <a href="http://cppcon.org">CPPCON</a> in 2015.
Fedor Pikus gave an extremely interesting talk about template meta programming (<a href="https://youtu.be/CZi6QqZSbFg">The recorded talk is on Youtube</a>).
The presented macro was part of his talk.</p>
<p>When using SFINAE the same way as presented and explained in the blog post which explains SFINAE, the type trait will pretty much look the same all the time.
The only details which differ are of course the type traits <em>name</em>, and the <em>expression</em> which does the actual magic.</p>
<p>The following macro does construct a type trait from two parameters:
The later type name of the constructed type trait, and the expression which it shall check for compilability.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#define DEFINE_IF_COMPILES</span><span class="op">(</span>NAME<span class="op">,</span><span class="pp"> </span>EXPR<span class="op">)</span><span class="pp"> </span><span class="op">\</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="pp">    </span><span class="kw">template</span><span class="pp"> </span><span class="op">&lt;</span><span class="kw">typename</span><span class="pp"> </span>U1<span class="op">&gt;</span><span class="pp"> </span><span class="op">\</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="pp">    </span><span class="kw">struct</span><span class="pp"> </span>NAME<span class="pp"> </span><span class="op">\</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="pp">    </span><span class="op">{</span><span class="pp"> </span><span class="op">\</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="pp">        </span><span class="kw">template</span><span class="pp"> </span><span class="op">&lt;</span><span class="kw">typename</span><span class="pp"> </span>U<span class="op">&gt;</span><span class="pp"> </span><span class="at">static</span><span class="pp"> </span>U<span class="op">&amp;</span><span class="pp"> </span>makeU<span class="op">();</span><span class="pp"> </span><span class="op">\</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="pp">        </span><span class="kw">using</span><span class="pp"> </span><span class="dt">yes_t</span><span class="pp"> </span><span class="op">=</span><span class="pp"> </span><span class="dt">char</span><span class="op">;</span><span class="pp"> </span><span class="op">\</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="pp">        </span><span class="kw">using</span><span class="pp"> </span><span class="dt">no_t</span><span class="pp">  </span><span class="op">=</span><span class="pp"> </span><span class="dt">char</span><span class="op">[</span><span class="dv">2</span><span class="op">];</span><span class="pp"> </span><span class="op">\</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="pp">        </span><span class="op">\</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="pp">        </span><span class="kw">template</span><span class="pp"> </span><span class="op">&lt;</span><span class="kw">typename</span><span class="pp"> </span>T1<span class="op">&gt;</span><span class="pp"> </span><span class="op">\</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="pp">        </span><span class="at">static</span><span class="pp"> </span><span class="dt">yes_t</span><span class="op">&amp;</span><span class="pp"> </span>f1<span class="op">(</span>T1<span class="pp"> </span><span class="op">&amp;</span>x1<span class="op">,</span><span class="pp"> </span><span class="dt">char</span><span class="pp"> </span><span class="op">(*</span>a<span class="op">)[</span><span class="kw">sizeof</span><span class="op">(</span><span class="pp"> </span>EXPR<span class="pp"> </span><span class="op">)]</span><span class="pp"> </span><span class="op">=</span><span class="pp"> </span><span class="kw">nullptr</span><span class="op">);</span><span class="pp"> </span><span class="op">\</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="pp">        </span><span class="kw">template</span><span class="pp"> </span><span class="op">&lt;</span><span class="kw">typename</span><span class="pp"> </span>T1<span class="op">&gt;</span><span class="pp"> </span><span class="op">\</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="pp">        </span><span class="at">static</span><span class="pp"> </span><span class="dt">no_t</span><span class="op">&amp;</span><span class="pp">  </span>f1<span class="op">(...);</span><span class="pp"> </span><span class="op">\</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="pp">        </span><span class="op">\</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="pp">        </span><span class="at">static</span><span class="pp"> </span><span class="kw">constexpr</span><span class="pp"> </span><span class="at">const</span><span class="pp"> </span><span class="dt">bool</span><span class="pp"> </span>value<span class="pp"> </span><span class="op">{</span><span class="pp"> </span><span class="op">\</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="pp">            </span><span class="kw">sizeof</span><span class="op">(</span>NAME<span class="op">::</span>f1<span class="op">&lt;</span>U1<span class="op">&gt;(</span>NAME<span class="op">::</span>makeU<span class="op">&lt;</span>U1<span class="op">&gt;()))</span><span class="pp"> </span><span class="op">==</span><span class="pp"> </span><span class="kw">sizeof</span><span class="op">(</span>NAME<span class="op">::</span><span class="dt">yes_t</span><span class="op">)};</span><span class="pp"> </span><span class="op">\</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="pp">    </span><span class="op">}</span></span></code></pre></div>
<p>The macro assumes a specific convention:
When checking an expression for compilability, the expression needs to be written in terms of an instance of the type on which the trait shall work.
This means, when the user writes <code>my_trait&lt;FooType&gt;::value</code>, the type trait will apply the expression defined by <code>EXPR</code>, on an artificial instance of type <code>FooType</code>.
In order to do that, <code>EXPR</code> needs access to such an instance, and the convention is, that such an instance is always provided with the name <code>x1</code>.</p>
<p>The following example will use the macro to create a type trait which can check if the user provided type is dereferenceable:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>DEFINE_IF_COMPILES<span class="op">(</span>is_dereferenceable<span class="op">,</span> <span class="op">*</span>x1<span class="op">);</span></span></code></pre></div>
<p>The type trait’s name is <code>is_dereferenceable</code>, and its expression is <code>*x1</code>.
It simply tries to dereference the artificial instance of the template type.</p>
<p>Usage then looks like the following:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">static_assert</span><span class="op">(</span>is_dereferenceable<span class="op">&lt;</span><span class="dt">int</span>                  <span class="op">&gt;::</span>value <span class="op">==</span> <span class="kw">false</span><span class="op">,</span> <span class="st">&quot;&quot;</span><span class="op">);</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="kw">static_assert</span><span class="op">(</span>is_dereferenceable<span class="op">&lt;</span><span class="dt">int</span><span class="op">*</span>                 <span class="op">&gt;::</span>value <span class="op">==</span> <span class="kw">true</span><span class="op">,</span>  <span class="st">&quot;&quot;</span><span class="op">);</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="kw">static_assert</span><span class="op">(</span>is_dereferenceable<span class="op">&lt;</span>vector<span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;::</span>iterator<span class="op">&gt;::</span>value <span class="op">==</span> <span class="kw">true</span><span class="op">,</span>  <span class="st">&quot;&quot;</span><span class="op">);</span></span></code></pre></div>
<p>This is pretty cool and easy to use.
It is not necessary to look for specific members, specialize any template structs/functions, etc., to see if some type is dereferenceable like an array, an iterator, or a smart pointer.</p>
<p>Some more examples, which are hopefully self-explanatory enough:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>DEFINE_IF_COMPILES<span class="op">(</span>has_begin_function<span class="op">,</span>             x1<span class="op">.</span>begin<span class="op">());</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>DEFINE_IF_COMPILES<span class="op">(</span>supports_addition_with_ints<span class="op">,</span>    x1 <span class="op">+</span> <span class="dv">123</span><span class="op">);</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>DEFINE_IF_COMPILES<span class="op">(</span>supports_addition_with_strings<span class="op">,</span> x1 <span class="op">+</span> <span class="st">&quot;abc&quot;</span><span class="op">);</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>DEFINE_IF_COMPILES<span class="op">(</span>is_serializable<span class="op">,</span>                x1<span class="op">.</span>serialize<span class="op">());</span></span></code></pre></div>
<p>It is possible to complicate this further by providing a macro which enables for expressions like <code>two_type_trait&lt;T, U&gt;::value</code>, which provides instances <code>x1</code> and <code>x2</code> (Example: <code>supports_addition&lt;T, U&gt;::value</code>, which tries to add: <code>x1 + x2</code>).
The macro is easily extensible to support that.</p></div>
</div>
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.1/cookieconsent.min.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.1/cookieconsent.min.js" data-cfasync="false"></script></script>
<script>var popup;
window.addEventListener('load', function(){window.cookieconsent.initialise({//set revokeBtn if you don't want to see a tiny pullup bar overlapping your website
//if revokeBtn is set, make sure to include a link to cookie settings in your footer
//you can open your banner again with: popup.open();
//revokeBtn: "<div class='cc-revoke'></div>",
type: "opt-in",
theme: "edgeless",
content: {message: 'Wir benutzen Cookies, um zu messen, welche Inhalte auf Interesse stoßen. Die Erlaubnis kann jederzeit rückgängig gemacht werden. / We use cookies to measure which content is of interest to you. You can revoke your approval at any time',
href: '/datenschutz.html#cookie-richtlinie',
allow: 'Cookies erlauben / Allow cookies',
deny: 'Nur technisch notwendige Cookies / Only technically necessary cookies',
link: 'Mehr dazu / Learn more',},
palette: {popup: {background: "#202020",
text: "#fff"
},button: {background: "#268bd2",
text: "#fff"
}},
onInitialise: function(status) {if(status == cookieconsent.status.allow) setCookies();},
onStatusChange: function(status) {if (this.hasConsented()) setCookies();
else deleteCookies(this.options.cookie.name)},
law: { regionalLaw: false, },
location: true,
function (p) { popup = p; }});})
//it is absolutely crucial to define gtag in the global scope
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-WZ3FX4G3XS', {'anonymize_ip': true});
function setCookies() {var s = document.createElement('script');
s.type = "text/javascript"
s.async = "true";
s.src = "https://www.googletagmanager.com/gtag/js?id=G-WZ3FX4G3XS";
var x = document.getElementsByTagName('script')[0];
x.parentNode.insertBefore(s, x);};
function deleteCookies(cookieconsent_name) {var keep = [cookieconsent_name, "DYNSRV"];
document.cookie.split(';').forEach(function(c) {c = c.split('=')[0].trim();
if (!~keep.indexOf(c))document.cookie = c + '=;' + 'expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/';});};</script>
</body>
</html>
