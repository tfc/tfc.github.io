<!doctype html>
<html lang="en-us"><head><link href="http://gmpg.org/xfn/11" rel="profile">
<link type="application/atom+xml" rel="alternate" href="https://blog.galowicz.de//feed.xml" title="Jacek's C++ Blog" />
<link rel="canonical" href="https://blog.galowicz.de/" />
<link rel="stylesheet" href="../../../../css/poole.css">
<link rel="stylesheet" href="../../../../css/syntax.css">
<link rel="stylesheet" href="../../../../css/hyde.css">
<link rel="stylesheet" href="//fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">
<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="../../../../images/apple-touch-icon-144-precomposed.png">
<link rel="shortcut icon" href="../../../../images/favicon.ico">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<title>Jacek's C++ Blog &middot; Setting up a C++ project environment with nix</title>
<body class="layout-reverse"><div class="sidebar"><div class="container sidebar-sticky"><div class="sidebar-about"><h1><a href="../../../../">Jacek's C++ Blog</a>
</h1>
<p class="lead">Writing about daily experiences and thoughts with C++ as my main work language.</p>
</div>
<nav class="sidebar-nav"><a class="sidebar-nav-item active" href="../../../../">Home</a>
<a class="sidebar-nav-item" href="../../../../about.html">About</a>
<a class="sidebar-nav-item" href="https://galowicz.de">CV Info</a>
<a class="sidebar-nav-item" href="../../../../impressum.html">Impressum/Datenschutz</a>
</nav>
<p><a href="https://linkedin.com/in/jgalowicz"><i class="fa fa-linkedin-square"></i>
</a>
<a href="https://www.xing.com/profile/Jacek_Galowicz"><i class="fa fa-xing-square"></i>
</a>
<a href="https://github.com/tfc"><i class="fa fa-github-square"></i>
</a>
<a href="https://plus.google.com/+JacekGalowicz"><i class="fa fa-google-plus-square"></i>
</a>
<a href="https://twitter.com/jgalowicz"><i class="fa fa-twitter-square"></i>
</a>
</p>
</div>
</div>
<div class="content container"><h1>Setting up a C++ project environment with nix</h1>
<div class="post"><span class="post-date">April 17, 2019</span>
<p>This article explains how to quickly set up a C++ project environment with complete toolchain- and dependency management with <code>nix</code>. <a href="https://nixos.org/nix/"><code>nix</code></a> is a powerful package manager for Linux and other Unix systems (It is indeed a more powerful alternative to <a href="https://conan.io/"><code>conan</code></a> and <a href="https://www.docker.com/"><code>docker</code></a>) that makes package management reliable and reproducible. After setting up the project and playing around with it, we will <strong>parametrize</strong> the project description in order to automatically build it with different compilers and dependency library versions (GCC 7 &amp; 8, Clang 7 &amp; 8, lib <code>boost</code> 1.6.6 - 1.6.9, lib <code>poco</code> 1.9.0 &amp; 1.9.1).</p>
<!--more-->
<p>Let’s start with a fresh system where no C++ compiler and no development libraries are installed. The only tool that we require to be installed is <code>nix</code> (see the <a href="https://nixos.org/nix/download.html">installation guide on nixos.org</a> for installation instructions), because we are going to use it to perform the toolchain and dependency setup.</p>
<h2 id="creating-a-little-example-c-project">Creating a little example C++ Project</h2>
<p>Let’s write a C++ program with the following dependencies:</p>
<ul>
<li>C++ compiler, of course. That might be GCC or Clang.</li>
<li><code>boost</code> library (<a href="https://www.boost.org" class="uri">https://www.boost.org</a>)</li>
<li><code>poco</code> library (<a href="https://pocoproject.org" class="uri">https://pocoproject.org</a>)</li>
</ul>
<p>For the sake of having a simple example app, the program does nothing more than printing what compiler it was built with and which versions of <code>boost</code> and <code>poco</code> it is linked against.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb1-1" title="1"><span class="co">#include &lt;boost/lexical_cast.hpp&gt;</span></a>
<a class="sourceLine" id="cb1-2" title="2"><span class="co">#include &lt;Poco/Environment.h&gt;</span></a>
<a class="sourceLine" id="cb1-3" title="3"><span class="co">#include &lt;iostream&gt;</span></a>
<a class="sourceLine" id="cb1-4" title="4"></a>
<a class="sourceLine" id="cb1-5" title="5"><span class="co">#if defined(__clang__)</span></a>
<a class="sourceLine" id="cb1-6" title="6"><span class="co">#define CC &quot;clang++&quot;</span></a>
<a class="sourceLine" id="cb1-7" title="7"><span class="co">#elif defined (__GNUC__)</span></a>
<a class="sourceLine" id="cb1-8" title="8"><span class="co">#define CC &quot;g++&quot;</span></a>
<a class="sourceLine" id="cb1-9" title="9"><span class="co">#else</span></a>
<a class="sourceLine" id="cb1-10" title="10"><span class="co">#define CC &quot;&lt;unknown compiler&gt;&quot;</span></a>
<a class="sourceLine" id="cb1-11" title="11"><span class="co">#endif</span></a>
<a class="sourceLine" id="cb1-12" title="12"></a>
<a class="sourceLine" id="cb1-13" title="13"><span class="ex">int</span> main() <span class="kw">{</span></a>
<a class="sourceLine" id="cb1-14" title="14">  <span class="ex">std</span>::cout <span class="op">&lt;&lt; &quot;Hello</span> <span class="ex">World</span>!\n<span class="st">&quot;</span></a>
<a class="sourceLine" id="cb1-15" title="15"><span class="st">    &lt;&lt; &quot;</span>Compiler: <span class="st">&quot; &lt;&lt; CC &lt;&lt; &quot;</span> <span class="st">&quot; &lt;&lt; __VERSION__ &lt;&lt; '\n'</span></a>
<a class="sourceLine" id="cb1-16" title="16"><span class="st">    &lt;&lt; &quot;</span>Boost: <span class="st">&quot; &lt;&lt; (BOOST_VERSION / 100000) &lt;&lt; '.'</span></a>
<a class="sourceLine" id="cb1-17" title="17"><span class="st">                 &lt;&lt; (BOOST_VERSION / 100 % 1000) &lt;&lt; '.'</span></a>
<a class="sourceLine" id="cb1-18" title="18"><span class="st">                 &lt;&lt; (BOOST_VERSION % 100) &lt;&lt; '\n'</span></a>
<a class="sourceLine" id="cb1-19" title="19"><span class="st">    &lt;&lt; &quot;</span>POCO: <span class="st">&quot; &lt;&lt; (Poco::Environment::libraryVersion() &gt;&gt; 24) &lt;&lt; '.'</span></a>
<a class="sourceLine" id="cb1-20" title="20"><span class="st">                &lt;&lt; (Poco::Environment::libraryVersion() &gt;&gt; 16 &amp; 0xff) &lt;&lt; '.'</span></a>
<a class="sourceLine" id="cb1-21" title="21"><span class="st">                &lt;&lt; (Poco::Environment::libraryVersion() &gt;&gt; 8 &amp; 0xff)</span></a>
<a class="sourceLine" id="cb1-22" title="22"><span class="st">                &lt;&lt; '\n';</span></a>
<a class="sourceLine" id="cb1-23" title="23"><span class="st">}</span></a></code></pre></div>
<p>We can either <em>install</em> a C++ compiler by running <code>nix-env</code> with the appropriate arguments, or just run a shell that exposes a C++ compiler in its <code>PATH</code> environment. Let us not clutter the system’s <code>PATH</code> environment with compilers from the beginning, because often people would use different compilers for each project anyway.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb2-1" title="1">$ <span class="ex">nix-shell</span> -p gcc</a>
<a class="sourceLine" id="cb2-2" title="2"></a>
<a class="sourceLine" id="cb2-3" title="3">[<span class="ex">nix-shell</span>:~]$ c++ --version</a>
<a class="sourceLine" id="cb2-4" title="4"><span class="ex">g++</span> (GCC) <span class="ex">7.4.0</span></a>
<a class="sourceLine" id="cb2-5" title="5"><span class="ex">Copyright</span> (C) <span class="ex">2017</span> Free Software Foundation, Inc.</a>
<a class="sourceLine" id="cb2-6" title="6"><span class="ex">This</span> is free software<span class="kw">;</span> <span class="ex">see</span> the source for copying conditions.  There is NO</a>
<a class="sourceLine" id="cb2-7" title="7"><span class="ex">warranty</span><span class="kw">;</span> <span class="ex">not</span> even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.</a></code></pre></div>
<p>We are now in a shell that includes GCC’s C++ compiler in its <code>PATH</code>:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb3-1" title="1">[<span class="ex">nix-shell</span>:~/src/nix_cmake_example]$ echo <span class="va">$PATH</span></a>
<a class="sourceLine" id="cb3-2" title="2"><span class="ex">...</span>:/nix/store/ghzg4kg0sjif58smj2lfm2bdvjwim85y-gcc-wrapper-7.4.0/bin:...</a></code></pre></div>
<p>I trimmed the rest of the path list. What’s important here: The path list is full of paths that begin with <code>/nix/store/...</code>. Each of them could be considered what one would call a <em>package</em> on typical Linux distributions. We can easily install multiple compilers with different versions, or even the same version with different sets of patches applied, next to each other in <code>/nix/store</code> and not have any of them collide during a project’s build, because <code>nix</code> does simply only map the packages into the current <code>PATH</code> that are needed.</p>
<blockquote>
<p><code>nix</code> does even more than just exposing packages via the <code>PATH</code> to the executing shell: For a running build process it does also hide all paths that are <em>not</em> listed in the dependencies of a package in order to avoid unknown dependencies lurking into the project. In order to achieve that, it uses <a href="https://en.wikipedia.org/wiki/Linux_namespaces"><em>namespaces</em></a>, similar to <a href="https://www.docker.com/">Docker</a>. See also: <a href="https://nixos.wiki/wiki/Nix#Sandboxing">nixos.wiki about <strong>sandboxing</strong></a>, and <a href="https://nixos.org/nix/manual/#conf-sandbox">nix manual: <code>sandbox</code> setting</a></p>
</blockquote>
<p>The full procedure of using <code>nix-shell</code> to setup the environment and building and running the app looks like this:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb4-1" title="1">$ <span class="ex">nix-shell</span> -p gcc boost poco</a>
<a class="sourceLine" id="cb4-2" title="2"></a>
<a class="sourceLine" id="cb4-3" title="3">$ <span class="ex">c++</span> -o main main.cpp -lPocoFoundation -lboost_system</a>
<a class="sourceLine" id="cb4-4" title="4"></a>
<a class="sourceLine" id="cb4-5" title="5">$ <span class="ex">./main</span></a>
<a class="sourceLine" id="cb4-6" title="6"><span class="ex">Hello</span> World!</a>
<a class="sourceLine" id="cb4-7" title="7"><span class="ex">Compiler</span>: g++ 7.4.0</a>
<a class="sourceLine" id="cb4-8" title="8"><span class="ex">Boost</span>: 1.67.0</a>
<a class="sourceLine" id="cb4-9" title="9"><span class="ex">POCO</span>: 1.9.0</a></code></pre></div>
<blockquote>
<p>Running the compiled binary can of course be done without <code>nix-shell</code>.</p>
</blockquote>
<p>One would typically add a file called <code>default.nix</code> to the project folder:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode nix"><code class="sourceCode bash"><a class="sourceLine" id="cb5-1" title="1"><span class="ex">with</span> import <span class="op">&lt;</span>nixpkgs<span class="op">&gt;</span> {};</a>
<a class="sourceLine" id="cb5-2" title="2"></a>
<a class="sourceLine" id="cb5-3" title="3"><span class="ex">stdenv.mkDerivation</span> {</a>
<a class="sourceLine" id="cb5-4" title="4">  <span class="ex">name</span> = <span class="st">&quot;my-app&quot;</span><span class="kw">;</span></a>
<a class="sourceLine" id="cb5-5" title="5">  <span class="ex">src</span> = ./.<span class="kw">;</span></a>
<a class="sourceLine" id="cb5-6" title="6"></a>
<a class="sourceLine" id="cb5-7" title="7">  <span class="ex">buildInputs</span> = [ boost poco ]<span class="kw">;</span></a>
<a class="sourceLine" id="cb5-8" title="8"></a>
<a class="sourceLine" id="cb5-9" title="9">  <span class="ex">buildPhase</span> = <span class="st">&quot;c++ -o main main.cpp -lPocoFoundation -lboost_system&quot;</span><span class="kw">;</span></a>
<a class="sourceLine" id="cb5-10" title="10"></a>
<a class="sourceLine" id="cb5-11" title="11">  <span class="ex">installPhase</span> = <span class="st">''</span></a>
<a class="sourceLine" id="cb5-12" title="12">    <span class="fu">mkdir</span> -p <span class="va">$out</span>/bin</a>
<a class="sourceLine" id="cb5-13" title="13">    <span class="fu">cp</span> main <span class="va">$out</span>/bin/</a>
<a class="sourceLine" id="cb5-14" title="14">  <span class="st">''</span>;</a>
<a class="sourceLine" id="cb5-15" title="15">}</a></code></pre></div>
<p>This buys us that we can simply run <code>nix-build</code> to configure, build and package the project into the nix store with a single command. Developers would still use <code>nix-shell</code> for incremental builds between source modifications. <code>nix-shell</code> does also consult <code>default.nix</code> in order to setup the dependencies right, so we don’t need the <code>-p</code> parameter list any longer.</p>
<p>Very short overview over the most important lines:</p>
<ul>
<li><code>stdenv</code> is an object in the nix expression language that is imported from <code>&lt;nixpkgs&gt;</code>. <code>nixpkgs</code> is a globally available nix expression with all the packages. <code>stdenv</code> contains the compiler and other things needed to compile projects.</li>
<li><code>buildInputs</code> lists compile time and run time dependencies of the project.</li>
<li><code>buildPhase</code> is a shell hook that describes how to build the program.</li>
<li><code>installPhase</code> describes what files should be copied into the nix store.</li>
</ul>
<p>We’re covering how this works in detail only in minimal depth. More information about nix derivations:</p>
<ul>
<li><a href="https://nixos.org/nix/manual/#ssec-derivation"><code>nix</code> manual section about derivations</a></li>
<li><a href="https://nixos.wiki/wiki/C" class="uri">https://nixos.wiki/wiki/C</a></li>
</ul>
<blockquote>
<p>It looks like we’re using <code>nix</code> as a build system now - in fact, <code>mkDerivation</code> is a function that creates a so called “builder script” that is able to detect if we are using a Makefile based project (with or without autoconf), a CMake project, or a set of other build systems, and then executes the right steps according to the build system. One cool detail is that we would typically not touch <code>CMakeFile</code> or other files in order to use <code>nix</code> - this way users who do not want to or cannot use <code>nix</code> are able to use their own tools for dependency management.</p>
<p><code>mkDerivation</code> is a very versatile and complex helper: See the <a href="https://nixos.org/nix/manual/#ssec-derivation"><code>nix</code> manual section about derivations</a></p>
</blockquote>
<p>In this example we use no build system, hence need to use the <code>buildPhase</code> hook to define how our little application is compiled and linked.</p>
<p>Someone else who checks out this project and who has installed <code>nix</code> can now simply run:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb6-1" title="1">$ <span class="ex">nix-build</span></a>
<a class="sourceLine" id="cb6-2" title="2"><span class="ex">these</span> derivations will be built:</a>
<a class="sourceLine" id="cb6-3" title="3"><span class="ex">/nix/store/dw9d2r7rykym08fzmdgf6v0ia2sn6hq9-my-app.drv</span></a>
<a class="sourceLine" id="cb6-4" title="4"><span class="ex">building</span> <span class="st">'/nix/store/dw9d2r7rykym08fzmdgf6v0ia2sn6hq9-my-app.drv'</span>...</a>
<a class="sourceLine" id="cb6-5" title="5"><span class="ex">unpacking</span> sources</a>
<a class="sourceLine" id="cb6-6" title="6"><span class="ex">unpacking</span> source archive /nix/store/8zwsvxdkpjnyxnm9qs33qw3bi12h9gbm-nix_simple</a>
<a class="sourceLine" id="cb6-7" title="7"><span class="bu">source</span> root is nix_simple</a>
<a class="sourceLine" id="cb6-8" title="8"><span class="ex">patching</span> sources</a>
<a class="sourceLine" id="cb6-9" title="9"><span class="ex">configuring</span></a>
<a class="sourceLine" id="cb6-10" title="10"><span class="ex">no</span> configure script, doing nothing</a>
<a class="sourceLine" id="cb6-11" title="11"><span class="ex">building</span></a>
<a class="sourceLine" id="cb6-12" title="12"><span class="ex">installing</span></a>
<a class="sourceLine" id="cb6-13" title="13"><span class="ex">post-installation</span> fixup</a>
<a class="sourceLine" id="cb6-14" title="14"><span class="ex">shrinking</span> RPATHs of ELF executables and libraries in /nix/store/5ldpivphfbya4xw6kcss9vcdvp1mzrcf-my-app</a>
<a class="sourceLine" id="cb6-15" title="15"><span class="ex">shrinking</span> /nix/store/5ldpivphfbya4xw6kcss9vcdvp1mzrcf-my-app/bin/main</a>
<a class="sourceLine" id="cb6-16" title="16"><span class="fu">strip</span> is /nix/store/0y7jmqnj48ikjh37n3dl9kqw9hnn68nq-binutils-2.31.1/bin/strip</a>
<a class="sourceLine" id="cb6-17" title="17"><span class="ex">stripping</span> (with command strip and flags -S) <span class="kw">in</span> <span class="ex">/nix/store/5ldpivphfbya4xw6kcss9vcdvp1mzrcf-my-app/bin</span></a>
<a class="sourceLine" id="cb6-18" title="18"><span class="ex">patching</span> script interpreter paths in /nix/store/5ldpivphfbya4xw6kcss9vcdvp1mzrcf-my-app</a>
<a class="sourceLine" id="cb6-19" title="19"><span class="ex">checking</span> for references to /tmp/nix-build-my-app.drv-0/ in /nix/store/5ldpivphfbya4xw6kcss9vcdvp1mzrcf-my-app...</a>
<a class="sourceLine" id="cb6-20" title="20"><span class="ex">/nix/store/5ldpivphfbya4xw6kcss9vcdvp1mzrcf-my-app</span></a>
<a class="sourceLine" id="cb6-21" title="21"></a>
<a class="sourceLine" id="cb6-22" title="22">$ <span class="ex">./result/bin/main</span></a>
<a class="sourceLine" id="cb6-23" title="23"><span class="ex">Hello</span> World!</a>
<a class="sourceLine" id="cb6-24" title="24"><span class="ex">Compiler</span>: g++ 7.4.0</a>
<a class="sourceLine" id="cb6-25" title="25"><span class="ex">Boost</span>: 1.67.0</a>
<a class="sourceLine" id="cb6-26" title="26"><span class="ex">POCO</span>: 1.9.0</a></code></pre></div>
<p>The compiler, all libraries etc. are automatically downloaded and put into action. Much simpler than with <a href="https://conan.io/">conan</a>!</p>
<p>That is basically it: If the program grows, we will certainly switch to some build system - <code>nix</code> supports that without having to add nix-specific stuff into the build files (GNUMake, CMake, meson, etc. are supported. Have a look into the <a href="https://github.com/NixOS/nixpkgs/tree/master/pkgs/development/tools/build-managers"><code>nixpkgs</code> git repository folder for supported build systems</a>). If the number of dependencies grows, be that libraries or compile time tools, we can simply add them to the nix expression.</p>
<h2 id="building-the-code-with-different-dependency-versions">Building the code with different dependency versions</h2>
<p>The <code>default.nix</code> expression results in one so-called <em>derivation</em> that <code>nix</code> can materialize into a binary package in the nix storage. Let us now write another nix expression that takes multiple <code>boost</code> library versions, multiple <code>poco</code> library versions and multiple compilers, and that results in a <em>set</em> of derivations that nix can materialize using those.</p>
<p>We will use the following variety of dependency versions:</p>
<ul>
<li>GCC 7 &amp; 8</li>
<li>Clang 7 &amp; 8</li>
<li>lib <code>poco</code> 1.9.0 &amp; 1.9.1</li>
<li>lib <code>boost</code> 1.6.6 - 1.6.9</li>
</ul>
<p>…which results in <span class="math inline">2 * 2 * 2 * 4 = 32</span> different binaries.</p>
<p>Quick spoiler: The result of the nix expression that we are going to write will allow us to build and execute these 32 binaries with a single <code>nix-build release.nix</code> command.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb7-1" title="1">$ <span class="kw">for</span> <span class="ex">path</span> in <span class="va">$(</span><span class="ex">nix-build</span> release.nix<span class="va">)</span><span class="kw">;</span> <span class="kw">do</span> <span class="kw">\</span></a>
<a class="sourceLine" id="cb7-2" title="2"><span class="op">&gt;</span>   <span class="bu">echo</span> <span class="st">&quot;====&quot;</span><span class="kw">;</span> <span class="kw">\</span></a>
<a class="sourceLine" id="cb7-3" title="3"><span class="op">&gt;</span>   <span class="bu">echo</span> <span class="st">&quot;Output of </span><span class="va">$path</span><span class="st">/bin/main:&quot;</span><span class="kw">;</span> <span class="kw">\</span></a>
<a class="sourceLine" id="cb7-4" title="4"><span class="op">&gt;</span>   <span class="va">$path</span><span class="ex">/bin/main</span>; <span class="kw">\</span></a>
<a class="sourceLine" id="cb7-5" title="5"><span class="op">&gt;</span> <span class="kw">done</span></a>
<a class="sourceLine" id="cb7-6" title="6"><span class="co"># trimmed a lot of build output...</span></a>
<a class="sourceLine" id="cb7-7" title="7">====</a>
<a class="sourceLine" id="cb7-8" title="8"><span class="ex">Output</span> of /nix/store/246an1m3rwwgz58qc8hfwvqh28899ckm-my-app-clang7-poco190-boost166/bin/main:</a>
<a class="sourceLine" id="cb7-9" title="9"><span class="ex">Hello</span> World!</a>
<a class="sourceLine" id="cb7-10" title="10"><span class="ex">Compiler</span>: clang++ 4.2.1 Compatible Clang 7.0.1 (tags/RELEASE_701/final)</a>
<a class="sourceLine" id="cb7-11" title="11"><span class="ex">Boost</span>: 1.66.0</a>
<a class="sourceLine" id="cb7-12" title="12"><span class="ex">POCO</span>: 1.9.0</a>
<a class="sourceLine" id="cb7-13" title="13">====</a>
<a class="sourceLine" id="cb7-14" title="14"><span class="ex">Output</span> of /nix/store/cfh1cy03kly9wq6x6dzlza4d9kads6cd-my-app-clang7-poco190-boost167/bin/main:</a>
<a class="sourceLine" id="cb7-15" title="15"><span class="ex">Hello</span> World!</a>
<a class="sourceLine" id="cb7-16" title="16"><span class="ex">Compiler</span>: clang++ 4.2.1 Compatible Clang 7.0.1 (tags/RELEASE_701/final)</a>
<a class="sourceLine" id="cb7-17" title="17"><span class="ex">Boost</span>: 1.67.0</a>
<a class="sourceLine" id="cb7-18" title="18"><span class="ex">POCO</span>: 1.9.0</a>
<a class="sourceLine" id="cb7-19" title="19">====</a>
<a class="sourceLine" id="cb7-20" title="20"><span class="ex">Output</span> of /nix/store/jjbpj24x4gp2vpn355j0qsy117yrkhrd-my-app-clang7-poco190-boost168/bin/main:</a>
<a class="sourceLine" id="cb7-21" title="21"><span class="ex">Hello</span> World!</a>
<a class="sourceLine" id="cb7-22" title="22"><span class="ex">Compiler</span>: clang++ 4.2.1 Compatible Clang 7.0.1 (tags/RELEASE_701/final)</a>
<a class="sourceLine" id="cb7-23" title="23"><span class="ex">Boost</span>: 1.68.0</a>
<a class="sourceLine" id="cb7-24" title="24"><span class="ex">POCO</span>: 1.9.0</a>
<a class="sourceLine" id="cb7-25" title="25">====</a>
<a class="sourceLine" id="cb7-26" title="26"><span class="ex">Output</span> of /nix/store/f9fgwzpq9gn85abx9h1zr5c6j3bs4ks2-my-app-clang7-poco190-boost169/bin/main:</a>
<a class="sourceLine" id="cb7-27" title="27"><span class="ex">Hello</span> World!</a>
<a class="sourceLine" id="cb7-28" title="28"><span class="ex">Compiler</span>: clang++ 4.2.1 Compatible Clang 7.0.1 (tags/RELEASE_701/final)</a>
<a class="sourceLine" id="cb7-29" title="29"><span class="ex">Boost</span>: 1.69.0</a>
<a class="sourceLine" id="cb7-30" title="30"><span class="ex">POCO</span>: 1.9.0</a>
<a class="sourceLine" id="cb7-31" title="31">====</a>
<a class="sourceLine" id="cb7-32" title="32"><span class="ex">Output</span> of /nix/store/1wwff8p5rxjqjkhqifvhy833bl3mf8l3-my-app-clang7-poco191-boost166/bin/main:</a>
<a class="sourceLine" id="cb7-33" title="33"><span class="ex">Hello</span> World!</a>
<a class="sourceLine" id="cb7-34" title="34"><span class="ex">Compiler</span>: clang++ 4.2.1 Compatible Clang 7.0.1 (tags/RELEASE_701/final)</a>
<a class="sourceLine" id="cb7-35" title="35"><span class="ex">Boost</span>: 1.66.0</a>
<a class="sourceLine" id="cb7-36" title="36"><span class="ex">POCO</span>: 1.9.1</a>
<a class="sourceLine" id="cb7-37" title="37">====</a>
<a class="sourceLine" id="cb7-38" title="38"><span class="ex">Output</span> of /nix/store/3jdv2l0gp3za4q5rj8s4859bpiyscg0m-my-app-clang7-poco191-boost167/bin/main:</a>
<a class="sourceLine" id="cb7-39" title="39"><span class="ex">Hello</span> World!</a>
<a class="sourceLine" id="cb7-40" title="40"><span class="ex">Compiler</span>: clang++ 4.2.1 Compatible Clang 7.0.1 (tags/RELEASE_701/final)</a>
<a class="sourceLine" id="cb7-41" title="41"><span class="ex">Boost</span>: 1.67.0</a>
<a class="sourceLine" id="cb7-42" title="42"><span class="ex">POCO</span>: 1.9.1</a>
<a class="sourceLine" id="cb7-43" title="43">====</a>
<a class="sourceLine" id="cb7-44" title="44"><span class="ex">Output</span> of /nix/store/fcbypavfzrw8ajngaim7srvn9fylj7b3-my-app-clang7-poco191-boost168/bin/main:</a>
<a class="sourceLine" id="cb7-45" title="45"><span class="ex">Hello</span> World!</a>
<a class="sourceLine" id="cb7-46" title="46"><span class="ex">Compiler</span>: clang++ 4.2.1 Compatible Clang 7.0.1 (tags/RELEASE_701/final)</a>
<a class="sourceLine" id="cb7-47" title="47"><span class="ex">Boost</span>: 1.68.0</a>
<a class="sourceLine" id="cb7-48" title="48"><span class="ex">POCO</span>: 1.9.1</a>
<a class="sourceLine" id="cb7-49" title="49">====</a>
<a class="sourceLine" id="cb7-50" title="50"><span class="ex">Output</span> of /nix/store/a8d1mwqiay3qx60fzp6m70q89s0mpcwx-my-app-clang7-poco191-boost169/bin/main:</a>
<a class="sourceLine" id="cb7-51" title="51"><span class="ex">Hello</span> World!</a>
<a class="sourceLine" id="cb7-52" title="52"><span class="ex">Compiler</span>: clang++ 4.2.1 Compatible Clang 7.0.1 (tags/RELEASE_701/final)</a>
<a class="sourceLine" id="cb7-53" title="53"><span class="ex">Boost</span>: 1.69.0</a>
<a class="sourceLine" id="cb7-54" title="54"><span class="ex">POCO</span>: 1.9.1</a>
<a class="sourceLine" id="cb7-55" title="55">====</a>
<a class="sourceLine" id="cb7-56" title="56"><span class="ex">Output</span> of /nix/store/lhxdhmi9ficg9v9mkxv4zz9s4759r5z6-my-app-clang8-poco190-boost166/bin/main:</a>
<a class="sourceLine" id="cb7-57" title="57"><span class="ex">Hello</span> World!</a>
<a class="sourceLine" id="cb7-58" title="58"><span class="ex">Compiler</span>: clang++ 4.2.1 Compatible Clang 8.0.0 (tags/RELEASE_800/final)</a>
<a class="sourceLine" id="cb7-59" title="59"><span class="ex">Boost</span>: 1.66.0</a>
<a class="sourceLine" id="cb7-60" title="60"><span class="ex">POCO</span>: 1.9.0</a>
<a class="sourceLine" id="cb7-61" title="61">====</a>
<a class="sourceLine" id="cb7-62" title="62"><span class="ex">Output</span> of /nix/store/x4f34gi6p6ipa8lvqx2aj36nzipk2yv1-my-app-clang8-poco190-boost167/bin/main:</a>
<a class="sourceLine" id="cb7-63" title="63"><span class="ex">Hello</span> World!</a>
<a class="sourceLine" id="cb7-64" title="64"><span class="ex">Compiler</span>: clang++ 4.2.1 Compatible Clang 8.0.0 (tags/RELEASE_800/final)</a>
<a class="sourceLine" id="cb7-65" title="65"><span class="ex">Boost</span>: 1.67.0</a>
<a class="sourceLine" id="cb7-66" title="66"><span class="ex">POCO</span>: 1.9.0</a>
<a class="sourceLine" id="cb7-67" title="67">====</a>
<a class="sourceLine" id="cb7-68" title="68"><span class="ex">Output</span> of /nix/store/dqmy8gmkshi8glg2ldidpclzq2mrqbvw-my-app-clang8-poco190-boost168/bin/main:</a>
<a class="sourceLine" id="cb7-69" title="69"><span class="ex">Hello</span> World!</a>
<a class="sourceLine" id="cb7-70" title="70"><span class="ex">Compiler</span>: clang++ 4.2.1 Compatible Clang 8.0.0 (tags/RELEASE_800/final)</a>
<a class="sourceLine" id="cb7-71" title="71"><span class="ex">Boost</span>: 1.68.0</a>
<a class="sourceLine" id="cb7-72" title="72"><span class="ex">POCO</span>: 1.9.0</a>
<a class="sourceLine" id="cb7-73" title="73">====</a>
<a class="sourceLine" id="cb7-74" title="74"><span class="ex">Output</span> of /nix/store/s5qw1ff2qbx2aswnlvd7l7d60fdfyr0y-my-app-clang8-poco190-boost169/bin/main:</a>
<a class="sourceLine" id="cb7-75" title="75"><span class="ex">Hello</span> World!</a>
<a class="sourceLine" id="cb7-76" title="76"><span class="ex">Compiler</span>: clang++ 4.2.1 Compatible Clang 8.0.0 (tags/RELEASE_800/final)</a>
<a class="sourceLine" id="cb7-77" title="77"><span class="ex">Boost</span>: 1.69.0</a>
<a class="sourceLine" id="cb7-78" title="78"><span class="ex">POCO</span>: 1.9.0</a>
<a class="sourceLine" id="cb7-79" title="79">====</a>
<a class="sourceLine" id="cb7-80" title="80"><span class="ex">Output</span> of /nix/store/wf4ygk9lhkmfv98f9g05pndv4a0320j1-my-app-clang8-poco191-boost166/bin/main:</a>
<a class="sourceLine" id="cb7-81" title="81"><span class="ex">Hello</span> World!</a>
<a class="sourceLine" id="cb7-82" title="82"><span class="ex">Compiler</span>: clang++ 4.2.1 Compatible Clang 8.0.0 (tags/RELEASE_800/final)</a>
<a class="sourceLine" id="cb7-83" title="83"><span class="ex">Boost</span>: 1.66.0</a>
<a class="sourceLine" id="cb7-84" title="84"><span class="ex">POCO</span>: 1.9.1</a>
<a class="sourceLine" id="cb7-85" title="85">====</a>
<a class="sourceLine" id="cb7-86" title="86"><span class="ex">Output</span> of /nix/store/xg34s1bzr2h57hsbj6z0g93mwni7jcgk-my-app-clang8-poco191-boost167/bin/main:</a>
<a class="sourceLine" id="cb7-87" title="87"><span class="ex">Hello</span> World!</a>
<a class="sourceLine" id="cb7-88" title="88"><span class="ex">Compiler</span>: clang++ 4.2.1 Compatible Clang 8.0.0 (tags/RELEASE_800/final)</a>
<a class="sourceLine" id="cb7-89" title="89"><span class="ex">Boost</span>: 1.67.0</a>
<a class="sourceLine" id="cb7-90" title="90"><span class="ex">POCO</span>: 1.9.1</a>
<a class="sourceLine" id="cb7-91" title="91">====</a>
<a class="sourceLine" id="cb7-92" title="92"><span class="ex">Output</span> of /nix/store/bhjzyxr1wpjnkdr1wm72142l0hlndsnz-my-app-clang8-poco191-boost168/bin/main:</a>
<a class="sourceLine" id="cb7-93" title="93"><span class="ex">Hello</span> World!</a>
<a class="sourceLine" id="cb7-94" title="94"><span class="ex">Compiler</span>: clang++ 4.2.1 Compatible Clang 8.0.0 (tags/RELEASE_800/final)</a>
<a class="sourceLine" id="cb7-95" title="95"><span class="ex">Boost</span>: 1.68.0</a>
<a class="sourceLine" id="cb7-96" title="96"><span class="ex">POCO</span>: 1.9.1</a>
<a class="sourceLine" id="cb7-97" title="97">====</a>
<a class="sourceLine" id="cb7-98" title="98"><span class="ex">Output</span> of /nix/store/r1nd2gb7r45vpldnbiprdnyg7y29k08f-my-app-clang8-poco191-boost169/bin/main:</a>
<a class="sourceLine" id="cb7-99" title="99"><span class="ex">Hello</span> World!</a>
<a class="sourceLine" id="cb7-100" title="100"><span class="ex">Compiler</span>: clang++ 4.2.1 Compatible Clang 8.0.0 (tags/RELEASE_800/final)</a>
<a class="sourceLine" id="cb7-101" title="101"><span class="ex">Boost</span>: 1.69.0</a>
<a class="sourceLine" id="cb7-102" title="102"><span class="ex">POCO</span>: 1.9.1</a>
<a class="sourceLine" id="cb7-103" title="103">====</a>
<a class="sourceLine" id="cb7-104" title="104"><span class="ex">Output</span> of /nix/store/3jfbck6mcrgjfpya8p8x293sfkqi0w5b-my-app-gcc7-poco190-boost166/bin/main:</a>
<a class="sourceLine" id="cb7-105" title="105"><span class="ex">Hello</span> World!</a>
<a class="sourceLine" id="cb7-106" title="106"><span class="ex">Compiler</span>: g++ 7.4.0</a>
<a class="sourceLine" id="cb7-107" title="107"><span class="ex">Boost</span>: 1.66.0</a>
<a class="sourceLine" id="cb7-108" title="108"><span class="ex">POCO</span>: 1.9.0</a>
<a class="sourceLine" id="cb7-109" title="109">====</a>
<a class="sourceLine" id="cb7-110" title="110"><span class="ex">Output</span> of /nix/store/cvlxdps8k666dgim3xp04xkm4qzbvkby-my-app-gcc7-poco190-boost167/bin/main:</a>
<a class="sourceLine" id="cb7-111" title="111"><span class="ex">Hello</span> World!</a>
<a class="sourceLine" id="cb7-112" title="112"><span class="ex">Compiler</span>: g++ 7.4.0</a>
<a class="sourceLine" id="cb7-113" title="113"><span class="ex">Boost</span>: 1.67.0</a>
<a class="sourceLine" id="cb7-114" title="114"><span class="ex">POCO</span>: 1.9.0</a>
<a class="sourceLine" id="cb7-115" title="115">====</a>
<a class="sourceLine" id="cb7-116" title="116"><span class="ex">Output</span> of /nix/store/ipk381rlahkv6wbwccmv7pibwghdbw7c-my-app-gcc7-poco190-boost168/bin/main:</a>
<a class="sourceLine" id="cb7-117" title="117"><span class="ex">Hello</span> World!</a>
<a class="sourceLine" id="cb7-118" title="118"><span class="ex">Compiler</span>: g++ 7.4.0</a>
<a class="sourceLine" id="cb7-119" title="119"><span class="ex">Boost</span>: 1.68.0</a>
<a class="sourceLine" id="cb7-120" title="120"><span class="ex">POCO</span>: 1.9.0</a>
<a class="sourceLine" id="cb7-121" title="121">====</a>
<a class="sourceLine" id="cb7-122" title="122"><span class="ex">Output</span> of /nix/store/pl9y9njmyc2ws4i4mgfnhdxxsbrzasj3-my-app-gcc7-poco190-boost169/bin/main:</a>
<a class="sourceLine" id="cb7-123" title="123"><span class="ex">Hello</span> World!</a>
<a class="sourceLine" id="cb7-124" title="124"><span class="ex">Compiler</span>: g++ 7.4.0</a>
<a class="sourceLine" id="cb7-125" title="125"><span class="ex">Boost</span>: 1.69.0</a>
<a class="sourceLine" id="cb7-126" title="126"><span class="ex">POCO</span>: 1.9.0</a>
<a class="sourceLine" id="cb7-127" title="127">====</a>
<a class="sourceLine" id="cb7-128" title="128"><span class="ex">Output</span> of /nix/store/svxr6826wm0sx9mm8sgy1v2aq2v1nx2p-my-app-gcc7-poco191-boost166/bin/main:</a>
<a class="sourceLine" id="cb7-129" title="129"><span class="ex">Hello</span> World!</a>
<a class="sourceLine" id="cb7-130" title="130"><span class="ex">Compiler</span>: g++ 7.4.0</a>
<a class="sourceLine" id="cb7-131" title="131"><span class="ex">Boost</span>: 1.66.0</a>
<a class="sourceLine" id="cb7-132" title="132"><span class="ex">POCO</span>: 1.9.1</a>
<a class="sourceLine" id="cb7-133" title="133">====</a>
<a class="sourceLine" id="cb7-134" title="134"><span class="ex">Output</span> of /nix/store/hfwv308iaykb4ygnjpjfxwy6xf1rr0s3-my-app-gcc7-poco191-boost167/bin/main:</a>
<a class="sourceLine" id="cb7-135" title="135"><span class="ex">Hello</span> World!</a>
<a class="sourceLine" id="cb7-136" title="136"><span class="ex">Compiler</span>: g++ 7.4.0</a>
<a class="sourceLine" id="cb7-137" title="137"><span class="ex">Boost</span>: 1.67.0</a>
<a class="sourceLine" id="cb7-138" title="138"><span class="ex">POCO</span>: 1.9.1</a>
<a class="sourceLine" id="cb7-139" title="139">====</a>
<a class="sourceLine" id="cb7-140" title="140"><span class="ex">Output</span> of /nix/store/2bxawcdkgjbvn756q93r65vym19b2jip-my-app-gcc7-poco191-boost168/bin/main:</a>
<a class="sourceLine" id="cb7-141" title="141"><span class="ex">Hello</span> World!</a>
<a class="sourceLine" id="cb7-142" title="142"><span class="ex">Compiler</span>: g++ 7.4.0</a>
<a class="sourceLine" id="cb7-143" title="143"><span class="ex">Boost</span>: 1.68.0</a>
<a class="sourceLine" id="cb7-144" title="144"><span class="ex">POCO</span>: 1.9.1</a>
<a class="sourceLine" id="cb7-145" title="145">====</a>
<a class="sourceLine" id="cb7-146" title="146"><span class="ex">Output</span> of /nix/store/zgzw1bbx935fm209lxnn01n14sv8f9a8-my-app-gcc7-poco191-boost169/bin/main:</a>
<a class="sourceLine" id="cb7-147" title="147"><span class="ex">Hello</span> World!</a>
<a class="sourceLine" id="cb7-148" title="148"><span class="ex">Compiler</span>: g++ 7.4.0</a>
<a class="sourceLine" id="cb7-149" title="149"><span class="ex">Boost</span>: 1.69.0</a>
<a class="sourceLine" id="cb7-150" title="150"><span class="ex">POCO</span>: 1.9.1</a>
<a class="sourceLine" id="cb7-151" title="151">====</a>
<a class="sourceLine" id="cb7-152" title="152"><span class="ex">Output</span> of /nix/store/jgsxmqgwmqqv2sbcmnx63abb3ymfsqc5-my-app-gcc8-poco190-boost166/bin/main:</a>
<a class="sourceLine" id="cb7-153" title="153"><span class="ex">Hello</span> World!</a>
<a class="sourceLine" id="cb7-154" title="154"><span class="ex">Compiler</span>: g++ 8.3.0</a>
<a class="sourceLine" id="cb7-155" title="155"><span class="ex">Boost</span>: 1.66.0</a>
<a class="sourceLine" id="cb7-156" title="156"><span class="ex">POCO</span>: 1.9.0</a>
<a class="sourceLine" id="cb7-157" title="157">====</a>
<a class="sourceLine" id="cb7-158" title="158"><span class="ex">Output</span> of /nix/store/3j9q4bn2id2iqza44n39mzi4cqzhqlz2-my-app-gcc8-poco190-boost167/bin/main:</a>
<a class="sourceLine" id="cb7-159" title="159"><span class="ex">Hello</span> World!</a>
<a class="sourceLine" id="cb7-160" title="160"><span class="ex">Compiler</span>: g++ 8.3.0</a>
<a class="sourceLine" id="cb7-161" title="161"><span class="ex">Boost</span>: 1.67.0</a>
<a class="sourceLine" id="cb7-162" title="162"><span class="ex">POCO</span>: 1.9.0</a>
<a class="sourceLine" id="cb7-163" title="163">====</a>
<a class="sourceLine" id="cb7-164" title="164"><span class="ex">Output</span> of /nix/store/7czfqh3fbjpslnar101b472kzlhxlcdc-my-app-gcc8-poco190-boost168/bin/main:</a>
<a class="sourceLine" id="cb7-165" title="165"><span class="ex">Hello</span> World!</a>
<a class="sourceLine" id="cb7-166" title="166"><span class="ex">Compiler</span>: g++ 8.3.0</a>
<a class="sourceLine" id="cb7-167" title="167"><span class="ex">Boost</span>: 1.68.0</a>
<a class="sourceLine" id="cb7-168" title="168"><span class="ex">POCO</span>: 1.9.0</a>
<a class="sourceLine" id="cb7-169" title="169">====</a>
<a class="sourceLine" id="cb7-170" title="170"><span class="ex">Output</span> of /nix/store/9vmwm0zzsgxqm6v5yxzjdjkhgxqqdnqr-my-app-gcc8-poco190-boost169/bin/main:</a>
<a class="sourceLine" id="cb7-171" title="171"><span class="ex">Hello</span> World!</a>
<a class="sourceLine" id="cb7-172" title="172"><span class="ex">Compiler</span>: g++ 8.3.0</a>
<a class="sourceLine" id="cb7-173" title="173"><span class="ex">Boost</span>: 1.69.0</a>
<a class="sourceLine" id="cb7-174" title="174"><span class="ex">POCO</span>: 1.9.0</a>
<a class="sourceLine" id="cb7-175" title="175">====</a>
<a class="sourceLine" id="cb7-176" title="176"><span class="ex">Output</span> of /nix/store/n34v5f23jhpcc20hyszdn270p9wyzfbz-my-app-gcc8-poco191-boost166/bin/main:</a>
<a class="sourceLine" id="cb7-177" title="177"><span class="ex">Hello</span> World!</a>
<a class="sourceLine" id="cb7-178" title="178"><span class="ex">Compiler</span>: g++ 8.3.0</a>
<a class="sourceLine" id="cb7-179" title="179"><span class="ex">Boost</span>: 1.66.0</a>
<a class="sourceLine" id="cb7-180" title="180"><span class="ex">POCO</span>: 1.9.1</a>
<a class="sourceLine" id="cb7-181" title="181">====</a>
<a class="sourceLine" id="cb7-182" title="182"><span class="ex">Output</span> of /nix/store/bq9pijnw746ilp1ar8xwb7bl3v1ypy0y-my-app-gcc8-poco191-boost167/bin/main:</a>
<a class="sourceLine" id="cb7-183" title="183"><span class="ex">Hello</span> World!</a>
<a class="sourceLine" id="cb7-184" title="184"><span class="ex">Compiler</span>: g++ 8.3.0</a>
<a class="sourceLine" id="cb7-185" title="185"><span class="ex">Boost</span>: 1.67.0</a>
<a class="sourceLine" id="cb7-186" title="186"><span class="ex">POCO</span>: 1.9.1</a>
<a class="sourceLine" id="cb7-187" title="187">====</a>
<a class="sourceLine" id="cb7-188" title="188"><span class="ex">Output</span> of /nix/store/pzqa2sraf1xhji9bk6namwg6x4ar9sgq-my-app-gcc8-poco191-boost168/bin/main:</a>
<a class="sourceLine" id="cb7-189" title="189"><span class="ex">Hello</span> World!</a>
<a class="sourceLine" id="cb7-190" title="190"><span class="ex">Compiler</span>: g++ 8.3.0</a>
<a class="sourceLine" id="cb7-191" title="191"><span class="ex">Boost</span>: 1.68.0</a>
<a class="sourceLine" id="cb7-192" title="192"><span class="ex">POCO</span>: 1.9.1</a>
<a class="sourceLine" id="cb7-193" title="193">====</a>
<a class="sourceLine" id="cb7-194" title="194"><span class="ex">Output</span> of /nix/store/vb3ha6skwnj2h5k691jxcn7pxa8gs90i-my-app-gcc8-poco191-boost169/bin/main:</a>
<a class="sourceLine" id="cb7-195" title="195"><span class="ex">Hello</span> World!</a>
<a class="sourceLine" id="cb7-196" title="196"><span class="ex">Compiler</span>: g++ 8.3.0</a>
<a class="sourceLine" id="cb7-197" title="197"><span class="ex">Boost</span>: 1.69.0</a>
<a class="sourceLine" id="cb7-198" title="198"><span class="ex">POCO</span>: 1.9.1</a></code></pre></div>
<p>As the first step, let us first decompose the <code>default.nix</code> file into a file <code>derivation.nix</code> and another file <code>release.nix</code>.</p>
<p>The new <code>derivation.nix</code> file contains the pure package description without knowledge about where the dependencies come from:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode nix"><code class="sourceCode bash"><a class="sourceLine" id="cb8-1" title="1"><span class="kw">{</span> <span class="ex">boost</span>, poco, stdenv <span class="kw">}</span>:</a>
<a class="sourceLine" id="cb8-2" title="2"></a>
<a class="sourceLine" id="cb8-3" title="3"><span class="ex">stdenv.mkDerivation</span> {</a>
<a class="sourceLine" id="cb8-4" title="4">  <span class="ex">name</span> = <span class="st">&quot;my-app&quot;</span><span class="kw">;</span></a>
<a class="sourceLine" id="cb8-5" title="5">  <span class="ex">src</span> = ./.<span class="kw">;</span></a>
<a class="sourceLine" id="cb8-6" title="6"></a>
<a class="sourceLine" id="cb8-7" title="7">  <span class="ex">buildInputs</span> = [ boost poco ]<span class="kw">;</span></a>
<a class="sourceLine" id="cb8-8" title="8"></a>
<a class="sourceLine" id="cb8-9" title="9">  <span class="ex">buildPhase</span> = <span class="st">&quot;c++ -std=c++17 -o main main.cpp -lPocoFoundation -lboost_system&quot;</span><span class="kw">;</span></a>
<a class="sourceLine" id="cb8-10" title="10"></a>
<a class="sourceLine" id="cb8-11" title="11">  <span class="ex">installPhase</span> = <span class="st">''</span></a>
<a class="sourceLine" id="cb8-12" title="12">    <span class="fu">mkdir</span> -p <span class="va">$out</span>/bin</a>
<a class="sourceLine" id="cb8-13" title="13">    <span class="fu">cp</span> main <span class="va">$out</span>/bin/</a>
<a class="sourceLine" id="cb8-14" title="14">  <span class="st">''</span>;</a>
<a class="sourceLine" id="cb8-15" title="15">}</a></code></pre></div>
<p>The first line states that the content of this file is a <em>function</em> that accepts a dictionary with the keys <code>boost</code>, <code>poco</code>, and <code>stdenv</code> as input arguments. It does then finally return a derivation. A derivation can be materialized into a package with the binary by <code>nix</code>.</p>
<p>This means that we can regard <code>derivation.nix</code> like a mathematical function<br />
<span class="math inline"><em>d</em><em>e</em><em>r</em><em>i</em><em>v</em>(<em>c</em><em>o</em><em>m</em><em>p</em><em>i</em><em>l</em><em>e</em><em>r</em>, <em>b</em><em>o</em><em>o</em><em>s</em><em>t</em>, <em>p</em><em>o</em><em>c</em><em>o</em>) → <em>d</em><em>e</em><em>r</em><em>i</em><em>v</em><em>a</em><em>t</em><em>i</em><em>o</em><em>n</em></span>.</p>
<p>The next step is then to use that function <span class="math inline"><em>d</em><em>e</em><em>r</em><em>i</em><em>v</em></span> and feed it with the cartesian product of all 32 input combinations. The file <code>release.nix</code> does just that:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode numberSource numberLines nix"><code class="sourceCode bash"><a class="sourceLine" id="cb9-1" title="1"><span class="kw">{</span></a>
<a class="sourceLine" id="cb9-2" title="2">  <span class="ex">nixpkgs</span> ? <span class="op">&lt;</span>nixpkgs<span class="op">&gt;</span>,</a>
<a class="sourceLine" id="cb9-3" title="3">  <span class="ex">pkgs</span> ? import nixpkgs {<span class="kw">}</span></a>
<a class="sourceLine" id="cb9-4" title="4">}:</a>
<a class="sourceLine" id="cb9-5" title="5"></a>
<a class="sourceLine" id="cb9-6" title="6"><span class="bu">let</span></a>
<a class="sourceLine" id="cb9-7" title="7">  <span class="ex">compilers</span> = with pkgs<span class="kw">;</span> <span class="kw">{</span></a>
<a class="sourceLine" id="cb9-8" title="8">    <span class="ex">gcc7</span> = stdenv<span class="kw">;</span></a>
<a class="sourceLine" id="cb9-9" title="9">    <span class="ex">gcc8</span> = overrideCC stdenv gcc8<span class="kw">;</span></a>
<a class="sourceLine" id="cb9-10" title="10">    <span class="ex">clang7</span> = overrideCC stdenv clang_7<span class="kw">;</span></a>
<a class="sourceLine" id="cb9-11" title="11">    <span class="ex">clang8</span> = overrideCC stdenv clang_8<span class="kw">;</span></a>
<a class="sourceLine" id="cb9-12" title="12">  <span class="kw">}</span>;</a>
<a class="sourceLine" id="cb9-13" title="13"></a>
<a class="sourceLine" id="cb9-14" title="14">  <span class="ex">pocoLibs</span> = {</a>
<a class="sourceLine" id="cb9-15" title="15">    <span class="ex">poco190</span> = pkgs.poco<span class="kw">;</span></a>
<a class="sourceLine" id="cb9-16" title="16">    <span class="ex">poco191</span> = pkgs.poco.overrideAttrs (oldAttrs: {</a>
<a class="sourceLine" id="cb9-17" title="17">      <span class="ex">name</span> = <span class="st">&quot;poco-1.9.1&quot;</span><span class="kw">;</span></a>
<a class="sourceLine" id="cb9-18" title="18">      <span class="ex">src</span> = pkgs.fetchgit {</a>
<a class="sourceLine" id="cb9-19" title="19">        <span class="ex">url</span> = <span class="st">&quot;https://github.com/pocoproject/poco.git&quot;</span><span class="kw">;</span></a>
<a class="sourceLine" id="cb9-20" title="20">        <span class="fu">rev</span> = <span class="st">&quot;196540ce34bf884921ff3f9ce338e38fc938acdd&quot;</span><span class="kw">;</span></a>
<a class="sourceLine" id="cb9-21" title="21">        <span class="ex">sha256</span> = <span class="st">&quot;0q0xihkm2z8kndx40150inq7llcyny59cv016gxsx0vbzzbdkcnd&quot;</span><span class="kw">;</span></a>
<a class="sourceLine" id="cb9-22" title="22">      };</a>
<a class="sourceLine" id="cb9-23" title="23">    });</a>
<a class="sourceLine" id="cb9-24" title="24">  };</a>
<a class="sourceLine" id="cb9-25" title="25"></a>
<a class="sourceLine" id="cb9-26" title="26">  <span class="ex">boostLibs</span> = {</a>
<a class="sourceLine" id="cb9-27" title="27">    <span class="ex">inherit</span> (pkgs) <span class="ex">boost166</span> boost167 boost168 boost169<span class="kw">;</span></a>
<a class="sourceLine" id="cb9-28" title="28">  };</a>
<a class="sourceLine" id="cb9-29" title="29"></a>
<a class="sourceLine" id="cb9-30" title="30">  <span class="ex">originalDerivation</span> = [ (pkgs.callPackage (import ./derivation.nix) {}) ];</a>
<a class="sourceLine" id="cb9-31" title="31"></a>
<a class="sourceLine" id="cb9-32" title="32">  <span class="ex">f</span> = libname: libs: derivs: with pkgs.lib<span class="kw">;</span></a>
<a class="sourceLine" id="cb9-33" title="33">    <span class="ex">concatMap</span> (deriv:</a>
<a class="sourceLine" id="cb9-34" title="34">      <span class="ex">mapAttrsToList</span> (libVers: lib:</a>
<a class="sourceLine" id="cb9-35" title="35">        <span class="kw">(</span><span class="ex">deriv.override</span> { <span class="st">&quot;</span><span class="va">${libname}</span><span class="st">&quot;</span> = lib<span class="kw">;</span> }<span class="kw">)</span><span class="ex">.overrideAttrs</span></a>
<a class="sourceLine" id="cb9-36" title="36">          <span class="kw">(</span><span class="ex">old</span>: { name = <span class="st">&quot;</span><span class="va">${old</span><span class="er">.name</span><span class="va">}</span><span class="st">-</span><span class="va">${libVers}</span><span class="st">&quot;</span><span class="kw">;</span> }<span class="kw">)</span></a>
<a class="sourceLine" id="cb9-37" title="37">      ) <span class="ex">libs</span></a>
<a class="sourceLine" id="cb9-38" title="38">    ) <span class="ex">derivs</span><span class="kw">;</span></a>
<a class="sourceLine" id="cb9-39" title="39"></a>
<a class="sourceLine" id="cb9-40" title="40">  <span class="ex">overrides</span> = [</a>
<a class="sourceLine" id="cb9-41" title="41">    <span class="kw">(</span><span class="ex">f</span> <span class="st">&quot;stdenv&quot;</span> compilers<span class="kw">)</span></a>
<a class="sourceLine" id="cb9-42" title="42">    <span class="kw">(</span><span class="ex">f</span> <span class="st">&quot;poco&quot;</span>   pocoLibs<span class="kw">)</span></a>
<a class="sourceLine" id="cb9-43" title="43">    <span class="kw">(</span><span class="ex">f</span> <span class="st">&quot;boost&quot;</span>  boostLibs<span class="kw">)</span></a>
<a class="sourceLine" id="cb9-44" title="44">  ];</a>
<a class="sourceLine" id="cb9-45" title="45"><span class="kw">in</span></a>
<a class="sourceLine" id="cb9-46" title="46">  <span class="ex">pkgs.lib.foldl</span> (a: b: a // { <span class="st">&quot;</span><span class="va">${b</span><span class="er">.name</span><span class="va">}</span><span class="st">&quot;</span> = b<span class="kw">;</span> }) {} <span class="kw">(</span></a>
<a class="sourceLine" id="cb9-47" title="47">    <span class="ex">pkgs.lib.foldl</span> (a: f: f a<span class="kw">)</span> <span class="ex">originalDerivation</span> overrides</a>
<a class="sourceLine" id="cb9-48" title="48">  )</a></code></pre></div>
<p>This code looks a bit more complicated, but it does a lot of things:</p>
<ul>
<li>It defines the variety of compilers and libraries in the variables <code>compilers</code>, <code>pocoLibs</code>, and <code>boostLibs</code>.
<ul>
<li>note that <code>nixpkgs</code> already contains lib <code>poco</code> version 1.9.0, but not 1.9.1 - we simply override its package description to use the latest 1.9.1 source from poco’s github repository.</li>
</ul></li>
<li>Function <code>f</code> contains all the magic: It reapplies the original function <code>deriv</code> with one library input overloaded from a library list argument!</li>
<li>The list <code>overrides</code> contains the list of function <code>f</code> applications that shall be applied over the original derivation.</li>
<li>The last 2 lines of code apply all the transformations within a simple <code>fold</code></li>
</ul>
<p>This explanation is very brief. The whole code might look pretty much familiar to everyone who is not used to nix but has some experience with purely functional programming languages. Explaining the code in detail to developers who neither know <code>nix</code> nor any functional programming, would explode the scope of this article.</p>
<h2 id="summary">Summary</h2>
<p>We have seen how simple it is to quickly set up an ad-hoc C++ programming environment with a compiler and libraries, without cluttering the system.</p>
<p>We have “packaged” our little project with a roughly ~10 LOC short <code>default.nix</code> Users with solely <code>nix</code> installed can clone this project from git, run <code>nix-build</code> and get the binary. Simple as that.</p>
<p>With less than 50 LOC we implemented a nix expression that builds our application in 32 different variants with different compilers and library versions.</p>
<p>There is a git repository with all project files that is available for checkout: <a href="https://github.com/tfc/nix_cpp_cartesian_dependencies" class="uri">https://github.com/tfc/nix_cpp_cartesian_dependencies</a></p>
<h2 id="outlook">Outlook</h2>
<p>What else can be done from here? The advantages and strengths of <code>nix</code> have <em>by far</em> not been exhausted in this example.</p>
<h3 id="maximum-reproducibility-pinning-nixpkgs">Maximum Reproducibility: Pinning <code>nixpkgs</code></h3>
<p>Whenever we referenced packages, we got them from the magical nix expression <code>&lt;nixpkgs&gt;</code>. This package source is a <em>channel</em> that can be updated with <code>nix-channel --update</code>, which is similar to running <code>apt-get update</code> on Debian-like Linux distros. Of course, an update of the channel also updates the packages and thus might break the whole build.</p>
<p>With <code>nix</code>, we can simply <strong>pin</strong> the package list to a version that is known to work.</p>
<p>In the github repository of this example, i did so with <a href="https://github.com/tfc/nix_cpp_cartesian_dependencies/blob/master/nixpkgs.nix">nixpkgs.nix</a>.</p>
<p>Using this technique, one can be pretty confident, that the project will still work in all configurations in a few years, which makes our build procedure pretty reproducible.</p>
<h3 id="nix-ci-hydra">Nix CI: Hydra</h3>
<p>Since <code>nix</code> is simply a tool that can be installed on Linux, Mac, and other UNIX systems, it can also be run in different CIs.</p>
<p>The NixOS project does however come with its own CI: <a href="https://nixos.org/hydra/">Hydra</a>. I am running my own instance on <a href="https://hydra.kosmosgame.com" class="uri">https://hydra.kosmosgame.com</a> and installed this project as a jobset on it:</p>
<p><a href="https://hydra.kosmosgame.com/jobset/github/nix_cpp_cartesian_dependencies#tabs-jobs">This article’s project in hydra</a></p>
<p>The code does a bit more than covered in this article: I added a nix expression <a href="https://github.com/tfc/nix_cpp_cartesian_dependencies/blob/master/output.nix"><code>output.nix</code></a> that does not only build the application in all variants, but also executes them and stores their results in the nix store. This way they can be looked at in the browser like here: <a href="https://hydra.kosmosgame.com/build/265">example output</a></p>
<h3 id="fully-reproducible-automatic-integration-tests">Fully Reproducible, Automatic Integration Tests</h3>
<p>Nix expressions do not only allow for simple ad-hoc packaging of binaries: They are mighty enough to describe whole-system descriptions. In fact, the NixOS installer ISOs, the Virtualbox NixOS demo VM image, the Amazon AMIs, Microsoft Azure Blobs, etc. are all built from nix expressions.</p>
<p>I build a little more complicated example and put it on github: <a href="https://github.com/tfc/nix_cmake_example" class="uri">https://github.com/tfc/nix_cmake_example</a></p>
<p>In a nutshell, this repository contains a C++ server application that uses PostgreSQL as a database backend and a Python client application that provides a little web server interface to the same database. In order to test such an application one needs a host with a confiured and running PostgreSQL instance.</p>
<p>The C++ app is built in different configurations - all configurations are automatically tested in VMs that are automatically created, spun up, and destroyed afterwards.</p>
<figure>
<img src="https://github.com/tfc/nix_cmake_example/raw/master/doc/hydra_nix_example.png" alt="Hydra example output" /><figcaption>Hydra example output</figcaption>
</figure>
<p>The whole output can be inspected on <a href="https://hydra.kosmosgame.com/jobset/github/nix_cmake_example#tabs-jobs" class="uri">https://hydra.kosmosgame.com/jobset/github/nix_cmake_example#tabs-jobs</a></p>
<h3 id="cross-compilation">Cross Compilation</h3>
<p>Just touching this topic by dropping some links</p>
<ul>
<li><a href="https://nixos.wiki/wiki/Cross_Compiling" class="uri">https://nixos.wiki/wiki/Cross_Compiling</a></li>
<li><a href="https://matthewbauer.us/blog/beginners-guide-to-cross.html" class="uri">https://matthewbauer.us/blog/beginners-guide-to-cross.html</a></li>
</ul></div>
<div id="disqus_thread"></div>
<script>var disqus_developer = 1;
var disqus_config = function () {this.page.url = 'https://blog.galowicz.de/2019/04/17/tutorial_nix_cpp_setup/';
this.page.identifier = 'nicecpp/2019/04/17/tutorial_nix_cpp_setup/';};
(function() {var d = document, s = d.createElement('script');
s.src = '//nicecpp.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);})();</script>
</div>
<script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-28506344-2', 'auto');
ga('send', 'pageview');
gtag('config', 'UA-28506344-2', { 'anonymize_ip': true });</script>
</body>
</head>
</html>
